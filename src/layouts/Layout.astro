---
import "../style/header.css";
import Header from '../components/Header.astro';
import Favicon from '../../src/assets/logo.png';
import BlobAnimation from '../components/Background';
import '../style/header.css';
import 'aos/dist/aos.css';

interface Props {
	title: string;
}

const { title } = Astro.props;
---
<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content="Astro description" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href={Favicon.src} />
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>
	</head>
	<style>
/* Preloader container */
.preloader-container {
  position: fixed;
  left: 0;
  top: 0;
  bottom: 0;
  width: 100%;
  pointer-events: auto;
  z-index: 1000;
  color: black;
  opacity: 1;
}

/* Top section (57%) */
.top-section {
  position: absolute;
  height: 57%;
  z-index: 2;
  background-color: #000; /* gray-300 */
  display: flex;
  align-items: flex-end;
  left: 0;
  right: 0;
  top: 0;
  padding-left: 5rem;
  padding-right: 5rem;
  clip-path: polygon(0% 0%, 100% 0%, 100% 99.5755%, 0% 99.5755%);
}

/* Bottom section (44%) */
.bottom-section {
  position: absolute;
  height: 44%;
  background-color: #000; /* gray-300 */
  left: 0;
  right: 0;
  bottom: 0;
  padding: 5rem;
  display: flex;
  align-items: flex-end;
  text-align: center;
  clip-path: polygon(0% 0.4245%, 100% 0.4245%, 100% 100%, 0% 100%);
}

/* Logo container */
.logo-container {
  text-align: center;
  opacity: 0;
  width: 100%;
  position: relative;
  opacity: 1;
}

/* Logos wrapper */
.logos-wrapper {
  overflow: hidden;
  width: 100%;
  margin-bottom: 2.5rem;
}

.logos-inner {
  display: flex;
  justify-content: center;
  width: 100%;
}

/* Individual logos */
.logo-left,
.logo-center,
.logo-right {
  display: inline-flex;
  align-items: center;
}

.logo-center{
  position: relative;
  margin-right: 0.5rem;
}

/* Progress container */
.progress-container {
  display: flex;
  justify-content: center;
  position: relative;
  overflow: hidden;
  height: 0.15rem;
  opacity: 1;
}

.progress-track {
  width: 100%;
  height: 100%;
  background-color: rgba(205, 205, 205, 0.65);
}

/* Progress bar */
.progress-bar {
  width: 100%;
  height: 100%;
  position: absolute;
  left: 0;
  top: 0;
  background-color: #fff;
  transform-origin: left;
  transform: scaleX(0);
}

/* Percentage container */
.percentage-container{
  overflow: hidden;
  width: 100%;
  opacity: 1;
}

/* Percentage text */
.percentage-text, #percentageText{
  font-size: 1.5rem;
  font-weight: 300;
  color: #fff;
}

.text-logo-preload {
  font-size: 4rem;
  color: white;
  font-family: 'Terra';
}
	</style>
	<body>
		<div 
			id="preloader"
			class="preloader-container"
      style="background-color: #fff;"
		>

			<span id="topSection" class="top-section">
				<div id="logoContainer" class="logo-container">
					<div class="logos-wrapper">
						<div class="logos-inner">
						
							<div id="logoLeft" class="logo-left">
							  <span class="text-logo-preload">va</span>
							</div>

							
							<div id="logoCenter" class="logo-center">
								 <span class="text-logo-preload"> /</span>
							</div>

							
							<div id="logoRight" class="logo-right">
							  <span class="text-logo-preload">dev</span>
							</div>
						</div>
					</div>

					
					<div id="progressContainer" class="progress-container">
						<div class="progress-track"></div>
						<div id="progressBar" class="progress-bar"></div>
					</div>
				</div>
			</span>

			
			<span id="bottomSection" class="bottom-section">
				<div id="percentageContainer" class="percentage-container">
					<div>(<span id="percentageText">100%</span>)</div>
				</div>
			</span>
		</div>

		<BlobAnimation client:only/>
		<Header/>
		<main class="main">
			<slot />
		</main>
	</body>
	<script>
		import { gsap } from "gsap/dist/gsap";

		// refs
		const container = document.getElementById("preloader");
		const leftLogo = document.getElementById("logoLeft");
		const rightLogo = document.getElementById("logoRight");
		const centerLogo = document.getElementById("logoCenter");
		const progressBar = document.getElementById("progressBar");
		const percentageText = document.getElementById("percentageText");
		const topSection = document.getElementById("topSection");
		const bottomSection = document.getElementById("bottomSection");
		const logoContainer = document.getElementById("logoContainer");
		const progressContainer = document.getElementById("progressContainer");
		const percentageContainer = document.getElementById("percentageContainer");

		const animationConfig = {
			showAnimation: { duration: 0.8, ease: "power3.inOut" },
			revealIntro: { duration: 2, ease: "expo.inOut" },
			hideAnimation: { duration: 0.5, ease: "expo.inOut" }
		};

		function start() {
			// Los elementos ya tienen opacity: 1 desde el CSS, pero mantenemos la animaciÃ³n inicial
			gsap.to([logoContainer, progressContainer, percentageContainer], {
				opacity: 1,
				duration: animationConfig.showAnimation.duration,
				ease: animationConfig.showAnimation.ease,
				delay: 0.2
			});

			const progress = { value: 0 };

			gsap.to(progress, {
				value: 100,
				duration: 2,
				delay: 0.5,
				ease: "power2.out",
				onUpdate: () => {
					const v = progress.value / 100;
					gsap.set(progressBar, { scaleX: v });

					if (percentageText) {
						percentageText.textContent = `${Math.round(progress.value)}%`;
					}
				},
				onComplete: introAnimation
			});
		}

		function introAnimation() {
			gsap.delayedCall(0.3, () => {
				const tl = gsap.timeline({
					onComplete: () => { gsap.delayedCall(0.5, exitAnimation); }
				});

				tl.to(leftLogo, {
					x: -500,
					duration: animationConfig.revealIntro.duration,
					ease: animationConfig.revealIntro.ease
				});

				tl.to(
					rightLogo,
					{
						x: 500,
						duration: animationConfig.revealIntro.duration,
						ease: animationConfig.revealIntro.ease
					},
					0
				);

				tl.to(
					centerLogo,
					{
						opacity: 0,
						duration: animationConfig.revealIntro.duration * 0.5,
						ease: "power2.out"
					},
					animationConfig.revealIntro.duration * 0.5
				);
			});
		}

		function exitAnimation() {
			const tl = gsap.timeline({
				onComplete: () => {
					gsap.set(container, { autoAlpha: 0 });

					// Evento personalizado equivalente a onFinish()
					window.dispatchEvent(new Event("preloader:finish"));
				}
			});

			tl.to(topSection, {
				clipPath: "polygon(0% 0%, 100% 0%, 100% 0%, 0% 0%)",
				duration: animationConfig.hideAnimation.duration,
				ease: animationConfig.hideAnimation.ease
			});

			tl.to(
				bottomSection,
				{
					clipPath: "polygon(0% 100%, 100% 100%, 100% 100%, 0% 100%)",
					duration: animationConfig.hideAnimation.duration,
					ease: animationConfig.hideAnimation.ease
				},
				0
			);

			tl.to(container, { opacity: 0, duration: 0.5 });
		}

		start();
	</script>
</html>